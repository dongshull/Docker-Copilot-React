name: Code Quality & Tests

# è§¦å‘æ¡ä»¶
on:
  # æ‹‰å–è¯·æ±‚æ—¶è§¦å‘
  pull_request:
    branches:
      - master
      - main
      - dev
  
  # æ¨é€åˆ°ä»»ä½•åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - master
      - main
      - dev
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x]

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci

      # 4. æ£€æŸ¥ä»£ç æ ¼å¼ï¼ˆå¦‚æœæœ‰ prettierï¼‰
      - name: Check code formatting
        run: |
          if [ -f "package.json" ] && grep -q "prettier" package.json; then
            npm run format:check || true
          fi

      # 5. æ„å»ºé¡¹ç›®
      - name: Build project
        run: npm run build

      # 6. æ£€æŸ¥æ„å»ºäº§ç‰©å¤§å°
      - name: Check bundle size
        run: |
          echo "## ğŸ“¦ æ„å»ºäº§ç‰©å¤§å°"
          du -sh dist/
          ls -lh dist/assets/ || true

  # ESLint ä»£ç æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
  eslint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # å¦‚æœé¡¹ç›®é…ç½®äº† ESLint
      - name: Run ESLint
        run: |
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f ".eslintrc.yml" ]; then
            npm run lint || true
          fi

  # å®‰å…¨æ‰«æ
  security:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # æ£€æŸ¥ä¾èµ–ä¸­çš„å·²çŸ¥æ¼æ´
      - name: Run npm audit
        run: npm audit --audit-level=moderate || true

      # ä½¿ç”¨ Snyk è¿›è¡Œå®‰å…¨æ‰«æï¼ˆå¯é€‰ï¼Œéœ€è¦ Snyk Tokenï¼‰
      - name: Run Snyk Security Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  # ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šï¼ˆå¦‚æœæœ‰æµ‹è¯•ï¼‰
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æœé¡¹ç›®é…ç½®äº† test è„šæœ¬ï¼‰
      - name: Run tests
        run: |
          if grep -q '"test"' package.json; then
            npm test || true
          else
            echo "âš ï¸  No test script configured"
          fi

  # ç”Ÿæˆæ„å»ºæŠ¥å‘Š
  report:
    needs: [code-quality, eslint, security, test]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate report
        run: |
          echo "## âœ… è´¨é‡æ£€æŸ¥å®Œæˆ"
          echo ""
          echo "| æ£€æŸ¥é¡¹ | çŠ¶æ€ |"
          echo "|--------|------|"
          echo "| ä»£ç è´¨é‡ | ${{ needs.code-quality.result }} |"
          echo "| ESLint | ${{ needs.eslint.result }} |"
          echo "| å®‰å…¨æ‰«æ | ${{ needs.security.result }} |"
          echo "| æµ‹è¯• | ${{ needs.test.result }} |"
